# Миграция: Разделение сообщений по чатам

## Проблема
До этого изменения все сообщения сохранялись в один общий Hive box без привязки к конкретному чату. Это приводило к тому, что при открытии любого чата отображались ВСЕ сообщения со всех чатов.

## Решение

### 1. Модель Message (`lib/models/message.dart`)
Добавлено поле `chatId`:
```dart
final String? chatId; // Идентификатор чата, к которому относится сообщение
```

### 2. StorageService (`lib/services/storage_service.dart`)
Добавлены методы:
- `getMessagesByChat(String chatId)` - получить сообщения конкретного чата
- `deleteMessagesByChat(String chatId)` - удалить все сообщения чата
- `getRecentMessagesByChat(String chatId, {int days})` - сообщения чата за последние N дней
- `clearAllMessagesForMigration()` - очистка всех сообщений (для миграции)

### 3. ChatService (`lib/services/chat_service.dart`)
Изменения:
- Добавлено поле `_currentChatId` для отслеживания активного чата
- Добавлен метод `setChatId(String chatId)` - установка активного чата
- Обновлён `_loadMessages()` - загружает только сообщения текущего чата
- Обновлены все методы отправки (`sendTextMessage`, `sendFile`, `sendVoiceMessage`) - добавляют `chatId` к сообщениям
- Обновлены обработчики входящих сообщений - добавляют `chatId`

### 4. ChatScreen (`lib/screens/chat_screen.dart`)
При инициализации сервиса устанавливается `chatId`:
```dart
_chatService = ChatService(_webRTCService, widget.storageService);
await _chatService.setChatId(widget.chat.id);
```

### 5. Миграция (`lib/main.dart`)
При запуске приложения проверяются старые сообщения без `chatId`:
- Если найдены сообщения без `chatId` - все сообщения удаляются
- Это необходимо, так как старые сообщения невозможно корректно разделить по чатам

## Что делать пользователю

При первом запуске после обновления:
1. **Все старые сообщения будут удалены** (миграция)
2. Новые сообщения будут корректно разделяться по чатам
3. При подключении к устройству история синхронизируется заново

## Тестирование

1. Создайте два чата с разными кодами подключения
2. Отправьте сообщения в первом чате
3. Переключитесь на второй чат
4. **Ожидаемый результат**: во втором чате НЕТ сообщений из первого чата
5. Отправьте сообщения во втором чате
6. Вернитесь в первый чат
7. **Ожидаемый результат**: видите только сообщения отправленные в первом чате

## Будущие улучшения

- [ ] Экспорт/импорт истории чатов
- [ ] Архивация чатов с сообщениями
- [ ] Поиск по сообщениям конкретного чата
- [ ] Статистика по чату (количество сообщений, файлов и т.д.)

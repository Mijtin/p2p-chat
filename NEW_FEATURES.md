# Новые функции и исправления

## Дата: 11 февраля 2026

---

## 1. Блок "Синхронизированные устройства" (Synced Devices)

### Описание:
На экране подключения теперь отображается список устройств, с которыми ранее было установлено соединение. При нажатии на устройство происходит мгновенное подключение без ввода кода.

### Расположение:
Под блоком "Join Chat" появляется разделитель "OR" и затем карточка "Synced Devices".

### Функционал:
- Отображает иконку устройства, имя (Device XXXXXX), время последнего подключения
- Показывает количество сообщений в чате с этим устройством
- Кнопка обновления списка (refresh)
- Кнопка удаления устройства из списка (X)
- При нажатии на устройство - мгновенное подключение к чату

### Сохранение устройств:
- При успешном подключении устройство автоматически добавляется в список
- Сохраняется: deviceId, deviceName, connectionCode, lastConnectedAt, totalMessages
- При повторном подключении обновляется время и количество сообщений

### Файлы:
- `lib/services/storage_service.dart` - методы addPairedDevice, getPairedDevices, removePairedDevice
- `lib/screens/connect_screen.dart` - UI блока Synced Devices
- `lib/screens/chat_screen.dart` - сохранение устройства при подключении

---

## 2. Автовход без кода (Auto-Join)

### Описание:
Если устройство уже подключалось к чату ранее, при следующем запуске приложение автоматически подключится без ввода кода.

### Логика работы:
1. При первом подключении код и peerId сохраняются в локальное хранилище
2. При следующем запуске приложение проверяет сохранённые данные
3. Если данные есть - происходит автоподключение к той же комнате
4. Пользователь видит экран "Checking previous chat... Connecting without code"
5. После подключения открывается чат автоматически

### Файлы:
- `lib/services/room_manager.dart` - новый сервис управления комнатой
- `lib/screens/connect_screen.dart` - обновлён для поддержки auto-join

---

## 3. Динамическая смена isInitiator

### Описание:
Роль initiator теперь динамически меняется в зависимости от того, кто в комнате.

### Логика работы:
```
Начальное состояние:
- Первый кто создаёт чат = isInitiator (true)
- Второй кто подключается = isInitiator (false)

При отключении:
- Если initiator выходит, а в комнате остаётся другой участник
- Тот кто остался автоматически становится initiator (true)
- Когда initiator возвращается, он может стать non-initiator

При возврате:
- Если в комнате никого нет, первый кто заходит = initiator
- Если в комнате уже есть кто-то, заходящий = non-initiator
```

### Heartbeat механизм:
- Каждые 5 секунд отправляется presence сообщение
- Если другой участник не отвечает 20 секунд - считается offline
- При уходе initiator, оставшийся участник автоматически получает роль initiator

### Файлы:
- `lib/services/room_manager.dart` - управление ролями и heartbeat

---

## 4. Исправлено сохранение файлов на Android

### Проблема:
На Android 10+ (API 29+) нельзя просто так писать в общую папку Downloads из-за Scoped Storage.

### Решение:
- Файлы сохраняются в app-specific директорию: `/Android/data/[package]/files/ReceivedFiles/`
- Это не требует дополнительных разрешений
- Папка "ReceivedFiles" создаётся автоматически
- Пользователь видит сообщение "File saved to ReceivedFiles/filename"

### Для пользователя:
- Файлы доступны через кнопку "Open" в уведомлении
- Или через "Share" для отправки в другие приложения
- Файлы сохраняются до удаления приложения

### Файлы:
- `lib/widgets/message_bubble.dart` - обновлён метод `_saveFileToDownloads()`

---

## 5. Добавлен FileProvider для Android

### Для чего:
Безопасный доступ к файлам через ContentProvider (требуется для Android 7+)

### Файлы:
- `android/app/src/main/AndroidManifest.xml` - добавлен FileProvider
- `android/app/src/main/res/xml/file_paths.xml` - конфигурация путей

---

## Структура новых файлов:

```
lib/
  services/
    room_manager.dart          # Новый - управление комнатой и ролями
    
android/app/src/main/res/xml/
  file_paths.xml               # Новый - пути для FileProvider
```

## Обновлённые файлы:

```
lib/
  screens/
    connect_screen.dart        # + Synced Devices блок, автовход, RoomManager
    chat_screen.dart           # + сохранение paired device
  widgets/
    message_bubble.dart        # Android-специфичное сохранение
  services/
    webrtc_service.dart        # Метод reconnectWithIdentity()
    storage_service.dart       # Методы для paired devices
    
android/app/src/main/
  AndroidManifest.xml          # FileProvider и разрешения
```

---

## Тестирование:

### Сценарий 1: Synced Devices
1. Устройство А создаёт чат с кодом 123456
2. Устройство Б подключается с кодом 123456
3. Оба устройства обмениваются сообщениями
4. Выйти из чата на обоих устройствах (Disconnect)
5. На экране подключения у обоих появится блок "Synced Devices"
6. Нажать на устройство в списке
7. **Ожидается:** Мгновенное подключение без ввода кода

### Сценарий 2: Автовход
1. Устройство А создаёт чат с кодом 123456
2. Устройство Б подключается с кодом 123456
3. Оба устройства обмениваются сообщениями
4. Закрыть приложение на обоих устройствах (полностью)
5. Открыть приложение на устройстве А
6. **Ожидается:** Автоматическое подключение без ввода кода
7. Открыть приложение на устройстве Б
8. **Ожидается:** Автоматическое подключение без ввода кода

### Сценарий 3: Смена initiator
1. Устройство А создаёт чат (isInitiator = true)
2. Устройство Б подключается (isInitiator = false)
3. Устройство А выходит из чата (Disconnect)
4. Устройство Б остаётся в чате
5. **Ожидается:** Устройство Б автоматически становится initiator
6. Устройство А снова подключается с кодом
7. **Ожидается:** Устройство А теперь isInitiator = false

### Сценарий 4: Сохранение файлов на Android
1. Устройство А отправляет картинку устройству Б (Android)
2. Устройство Б нажимает "Save" на полученной картинке
3. **Ожидается:** Сообщение "File saved to ReceivedFiles/image.jpg"
4. Нажать "Open" в уведомлении
5. **Ожидается:** Картинка открывается в галерее/просмотрщике

---

## Сборка:

```bash
# Очистка
flutter clean

# Зависимости
flutter pub get

# Windows
flutter build windows --release

# Android
flutter build apk --release
```

## Важно:

- RoomManager - новая архитектура с heartbeat каждые 5 секунд
- Synced Devices - сохраняются автоматически при подключении
- Auto-join - работает если ранее было успешное подключение
- Все функции требуют тестирования на реальных устройствах

Готово к тестированию!
